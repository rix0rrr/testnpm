name: Publish to NPM

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish to NPM
        run: npm publish --provenance --access public

      - name: Obtain a publishing token
        run: |
          set -euo pipefail

          export PACKAGE_NAME=@rix0rrr/testnpm
          export RUNNER_DEBUG=1

          # Safely encode the package name
          ENCODED_PACKAGE=$(printf "%s" "$PACKAGE_NAME" | jq -Rr @uri)

          if [[ "$RUNNER_DEBUG" == "1" ]]; then
            echo "Encoded package name: $ENCODED_PACKAGE"
          fi

          # Request GitHub OIDC token with npm audience
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm:registry.npmjs.org" | jq -r '.value // empty')

          echo "OIDC TOKEN"
          echo "$OIDC_TOKEN"

          if [[ -z "$OIDC_TOKEN" ]]; then
            echo "::error::Failed to get OIDC token from GitHub"
            exit 1
          fi

          # Exchange OIDC token for npm auth token
          RESPONSE=$(curl -sS -X POST \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Accept: application/json" \
            -w "\n%{http_code}" \
            "https://registry.npmjs.org/-/npm/v1/oidc/token/exchange/package/$ENCODED_PACKAGE")

          echo "Response"
          echo "$RESPONSE"

          # Extract status code and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" != "201" ]]; then
            echo "::error::Failed to exchange token. Status: $HTTP_CODE"
            exit 1
          fi

          # Extract and mask the npm token
          NPM_TOKEN=$(echo "$BODY" | jq -r '.token // empty')

          if [[ -z "$NPM_TOKEN" ]]; then
            echo "::error::No token in response"
            exit 1
          fi

          echo "::add-mask::$NPM_TOKEN"
          echo "token=$NPM_TOKEN" >> $GITHUB_OUTPUT
          echo "NPM_TOKEN=$NPM_TOKEN" >> $GITHUB_ENV

      - name: Add a tag
        run: |
          v=$(node -p "require('./package.json').version")

          echo "NPM_TOKEN=$NPM_TOKEN"

          # Manual response
          curl \
            -H 'user-agent: npm/11.3.0 node/v24.2.0 darwin arm64 workspaces/false' \
            -H 'content-type: application/json' \
            -H 'npm-auth-type: web' \
            -H 'npm-command: dist-tag' \
            -H "authorization: Bearer ${NPM_TOKEN}" \
            -H 'Accept: */*' \
            --compressed \
            -H 'connection: keep-alive' \
            -Ssf \
            -X PUT https://registry.npmjs.org/-/package/@rix0rrr%2ftestnpm/dist-tags/bier -d '"1.0.0"'

          # npm dist-tag add @rix0rrr/testnpm@${v} cool-version
